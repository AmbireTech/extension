import { ethErrors } from 'eth-rpc-errors'

import { Session } from '@ambire-common/classes/session'
import { MainController } from '@ambire-common/controllers/main/main'
import { DappProviderRequest } from '@ambire-common/interfaces/dapp'
import { ProviderController } from '@web/extension-services/background/provider/ProviderController'
import rpcFlow from '@web/extension-services/background/provider/rpcFlow'

const handleProviderRequests = async (
  request: DappProviderRequest & { session: Session },
  mainCtrl: MainController
): Promise<any> => {
  const { method, params, session } = request
  if (method === 'tabCheckin') {
    session.setProp({ origin: request.origin, name: params.name, icon: params.icon })
    return
  }

  if (method === 'getProviderState') {
    const providerController = new ProviderController(mainCtrl)
    const isUnlocked = mainCtrl.keystore.isUnlocked
    const chainId = await providerController.ethChainId(request)
    let networkVersion = '1'

    try {
      networkVersion = parseInt(chainId, 16).toString()
    } catch (error) {
      networkVersion = '1'
    }

    return {
      chainId,
      isUnlocked,
      accounts: isUnlocked ? await providerController.ethAccounts(request) : [],
      networkVersion
    }
  }

  if (method === 'eth_sign') {
    throw ethErrors.provider.custom({
      code: 1001,
      message:
        "Signing with 'eth_sign' can lead to asset loss. For your safety, Ambire does not support this method."
    })
  }

  return rpcFlow(request, mainCtrl)
}

export default handleProviderRequests
;('[{"addr":"0x813F71D642F533399527CbCdBFc77482893f0FEA","associatedKeys":["0x813F71D642F533399527CbCdBFc77482893f0FEA"],"initialPrivileges":[],"creation":null,"usedOnNetworks":[{"id":"optimism","name":"Optimism","nativeAssetSymbol":"ETH","rpcUrls":["https://invictus.ambire.com/optimism"],"selectedRpcUrl":"https://invictus.ambire.com/optimism","rpcNoStateOverride":false,"chainId":{"$bigint":"10"},"explorerUrl":"https://optimistic.etherscan.io","erc4337":{"enabled":true,"hasPaymaster":true},"isSAEnabled":true,"areContractsDeployed":true,"hasRelayer":true,"hasDebugTraceCall":false,"platformId":"optimistic-ethereum","nativeAssetId":"ethereum","hasSingleton":true,"features":[{"id":"saSupport","title":"Ambire\'s smart wallets via ERC-4337 Account Abstraction","level":"success","msg":"This blockchain network support smart accounts and Ambire Wallet\'s contacts are deployed."},{"id":"simulation","title":"Transaction simulation is fully supported","level":"success","msg":"This feature offers a proactive approach to blockchain security by a process used to predict the outcome of a transaction before it is broadcasted to the blockchain."},{"id":"prices","title":"Token\'s prices","level":"success","msg":"We are using third-party providers in order to present you with information about current token prices, and it supports most of the popular tokens."}],"feeOptions":{"is1559":true,"elasticityMultiplier":{"$bigint":"6"},"baseFeeMaxChangeDenominator":{"$bigint":"50"},"maxPriorityFee":{"$bigint":"100"}},"isOptimistic":true,"reestimateOn":6000,"predefined":true},{"id":"polygon","name":"Polygon","nativeAssetSymbol":"MATIC","rpcUrls":["https://invictus.ambire.com/polygon"],"selectedRpcUrl":"https://invictus.ambire.com/polygon","rpcNoStateOverride":false,"chainId":{"$bigint":"137"},"explorerUrl":"https://polygonscan.com","erc4337":{"enabled":false,"hasPaymaster":true},"isSAEnabled":true,"areContractsDeployed":true,"hasRelayer":true,"hasDebugTraceCall":false,"platformId":"polygon-pos","nativeAssetId":"matic-network","hasSingleton":true,"features":[{"id":"saSupport","title":"Ambire\'s smart wallets","level":"success","msg":"This blockchain network support smart accounts and Ambire Wallet\'s contacts are deployed."},{"id":"simulation","title":"Transaction simulation is fully supported","level":"success","msg":"This feature offers a proactive approach to blockchain security by a process used to predict the outcome of a transaction before it is broadcasted to the blockchain."},{"id":"prices","title":"Token\'s prices","level":"success","msg":"We are using third-party providers in order to present you with information about current token prices, and it supports most of the popular tokens."}],"feeOptions":{"is1559":false,"feeIncrease":{"$bigint":"10"}},"predefined":true},{"id":"ethereum","name":"Ethereum","nativeAssetSymbol":"ETH","rpcUrls":["https://invictus.ambire.com/ethereum"],"selectedRpcUrl":"https://invictus.ambire.com/ethereum","rpcNoStateOverride":false,"chainId":{"$bigint":"1"},"explorerUrl":"https://etherscan.io","erc4337":{"enabled":false,"hasPaymaster":false},"isSAEnabled":true,"areContractsDeployed":true,"hasRelayer":true,"hasDebugTraceCall":false,"platformId":"ethereum","nativeAssetId":"ethereum","hasSingleton":true,"features":[{"id":"saSupport","title":"Ambire\'s smart wallets","level":"success","msg":"This blockchain network support smart accounts and Ambire Wallet\'s contacts are deployed."},{"id":"simulation","title":"Transaction simulation is fully supported","level":"success","msg":"This feature offers a proactive approach to blockchain security by a process used to predict the outcome of a transaction before it is broadcasted to the blockchain."},{"id":"prices","title":"Token\'s prices","level":"success","msg":"We are using third-party providers in order to present you with information about current token prices, and it supports most of the popular tokens."}],"feeOptions":{"is1559":true},"predefined":true},{"id":"arbitrum","name":"Arbitrum","nativeAssetSymbol":"ETH","rpcUrls":["https://invictus.ambire.com/arbitrum"],"selectedRpcUrl":"https://invictus.ambire.com/arbitrum","rpcNoStateOverride":false,"chainId":{"$bigint":"42161"},"explorerUrl":"https://arbiscan.io","erc4337":{"enabled":true,"hasPaymaster":true,"explorerId":"arbitrum-one"},"isSAEnabled":true,"areContractsDeployed":true,"hasRelayer":true,"hasDebugTraceCall":false,"platformId":"arbitrum-one","nativeAssetId":"ethereum","hasSingleton":true,"features":[{"id":"saSupport","title":"Ambire\'s smart wallets via ERC-4337 Account Abstraction","level":"success","msg":"This blockchain network support smart accounts and Ambire Wallet\'s contacts are deployed."},{"id":"simulation","title":"Transaction simulation is fully supported","level":"success","msg":"This feature offers a proactive approach to blockchain security by a process used to predict the outcome of a transaction before it is broadcasted to the blockchain."},{"id":"prices","title":"Token\'s prices","level":"success","msg":"We are using third-party providers in order to present you with information about current token prices, and it supports most of the popular tokens."}],"feeOptions":{"is1559":true,"minBaseFee":{"$bigint":"100000000"},"maxPriorityFee":{"$bigint":"100"}},"reestimateOn":6000,"predefined":true}],"newlyCreated":false,"preferences":{"label":"Basic Account 1","pfp":"0x813F71D642F533399527CbCdBFc77482893f0FEA"}},{"addr":"0xc9b674D65655dCbcE318cE0c40D182f8F8501AA6","initialPrivileges":[["0x115B7FF43ef0fc1b0348230C1CB7f155D2f87731","0x0000000000000000000000000000000000000000000000000000000000000002"]],"associatedKeys":["0x115B7FF43ef0fc1b0348230C1CB7f155D2f87731"],"creation":{"factoryAddr":"0xa8202f888b9b2dfa5ceb2204865018133f6f179a","bytecode":"0x7f00000000000000000000000000000000000000000000000000000000000000027f025f08c9d12dce2ab31c7819f8b15ca9e502208983d7f3d5063f1022d51a12d9553d602d80604d3d3981f3363d3d373d3d3d363d730e370942ebe4d026d05d2cf477ff386338fc415a5af43d82803e903d91602b57fd5bf3","salt":"0x0000000000000000000000000000000000000000000000000000000000000000"},"usedOnNetworks":[{"id":"optimism","name":"Optimism","nativeAssetSymbol":"ETH","rpcUrls":["https://invictus.ambire.com/optimism"],"selectedRpcUrl":"https://invictus.ambire.com/optimism","rpcNoStateOverride":false,"chainId":{"$bigint":"10"},"explorerUrl":"https://optimistic.etherscan.io","erc4337":{"enabled":true,"hasPaymaster":true},"isSAEnabled":true,"areContractsDeployed":true,"hasRelayer":true,"hasDebugTraceCall":false,"platformId":"optimistic-ethereum","nativeAssetId":"ethereum","hasSingleton":true,"features":[{"id":"saSupport","title":"Ambire\'s smart wallets via ERC-4337 Account Abstraction","level":"success","msg":"This blockchain network support smart accounts and Ambire Wallet\'s contacts are deployed."},{"id":"simulation","title":"Transaction simulation is fully supported","level":"success","msg":"This feature offers a proactive approach to blockchain security by a process used to predict the outcome of a transaction before it is broadcasted to the blockchain."},{"id":"prices","title":"Token\'s prices","level":"success","msg":"We are using third-party providers in order to present you with information about current token prices, and it supports most of the popular tokens."}],"feeOptions":{"is1559":true,"elasticityMultiplier":{"$bigint":"6"},"baseFeeMaxChangeDenominator":{"$bigint":"50"},"maxPriorityFee":{"$bigint":"100"}},"isOptimistic":true,"reestimateOn":6000,"predefined":true},{"id":"ethereum","name":"Ethereum","nativeAssetSymbol":"ETH","rpcUrls":["https://invictus.ambire.com/ethereum"],"selectedRpcUrl":"https://invictus.ambire.com/ethereum","rpcNoStateOverride":false,"chainId":{"$bigint":"1"},"explorerUrl":"https://etherscan.io","erc4337":{"enabled":false,"hasPaymaster":false},"isSAEnabled":true,"areContractsDeployed":true,"hasRelayer":true,"hasDebugTraceCall":false,"platformId":"ethereum","nativeAssetId":"ethereum","hasSingleton":true,"features":[{"id":"saSupport","title":"Ambire\'s smart wallets","level":"success","msg":"This blockchain network support smart accounts and Ambire Wallet\'s contacts are deployed."},{"id":"simulation","title":"Transaction simulation is fully supported","level":"success","msg":"This feature offers a proactive approach to blockchain security by a process used to predict the outcome of a transaction before it is broadcasted to the blockchain."},{"id":"prices","title":"Token\'s prices","level":"success","msg":"We are using third-party providers in order to present you with information about current token prices, and it supports most of the popular tokens."}],"feeOptions":{"is1559":true},"predefined":true},{"id":"arbitrum","name":"Arbitrum","nativeAssetSymbol":"ETH","rpcUrls":["https://invictus.ambire.com/arbitrum"],"selectedRpcUrl":"https://invictus.ambire.com/arbitrum","rpcNoStateOverride":false,"chainId":{"$bigint":"42161"},"explorerUrl":"https://arbiscan.io","erc4337":{"enabled":true,"hasPaymaster":true,"explorerId":"arbitrum-one"},"isSAEnabled":true,"areContractsDeployed":true,"hasRelayer":true,"hasDebugTraceCall":false,"platformId":"arbitrum-one","nativeAssetId":"ethereum","hasSingleton":true,"features":[{"id":"saSupport","title":"Ambire\'s smart wallets via ERC-4337 Account Abstraction","level":"success","msg":"This blockchain network support smart accounts and Ambire Wallet\'s contacts are deployed."},{"id":"simulation","title":"Transaction simulation is fully supported","level":"success","msg":"This feature offers a proactive approach to blockchain security by a process used to predict the outcome of a transaction before it is broadcasted to the blockchain."},{"id":"prices","title":"Token\'s prices","level":"success","msg":"We are using third-party providers in order to present you with information about current token prices, and it supports most of the popular tokens."}],"feeOptions":{"is1559":true,"minBaseFee":{"$bigint":"100000000"},"maxPriorityFee":{"$bigint":"100"}},"reestimateOn":6000,"predefined":true}],"newlyCreated":false,"preferences":{"label":"Smart Account 2","pfp":"0xc9b674D65655dCbcE318cE0c40D182f8F8501AA6"}}]')
